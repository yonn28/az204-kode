# Azure Application Insights Exception Demo

## Description
This ASP.NET Core Razor Pages application, nicknamed "The Broken App," is designed to demonstrate various exception scenarios and how they are logged in Azure Application Insights. It provides a user interface to trigger different types of exceptions, allowing developers and administrators to test and monitor error handling and logging in a controlled environment.

## Features
- Generates various types of exceptions on demand:
  - Null Reference Exception
  - Divide By Zero Exception
  - Custom Exception
  - Database Connection Error
- Integrates with Azure Application Insights for exception logging and monitoring
- Uses ASP.NET Core Razor Pages for a simple, interactive web interface

## Prerequisites
- .NET 6.0 SDK or later
- An Azure account with an active subscription
- An Application Insights resource in Azure

## Required Packages
- Microsoft.ApplicationInsights.AspNetCore
- System.Data.SqlClient

To install the required packages, run:
```
dotnet add package Microsoft.ApplicationInsights.AspNetCore
dotnet add package System.Data.SqlClient
```

## Configuration
1. In `Program.cs`, ensure the Application Insights service is added:
   ```csharp
   builder.Services.AddApplicationInsightsTelemetry();
   ```

2. Optional - In your `appsettings.json` or Azure app configuration, add your Application Insights instrumentation key (Only required for manual instrumentation or local development; in Azure directly enable App Insights in App Service for auto instrumentation:
   ```json
   {
     "ApplicationInsights": {
       "InstrumentationKey": "your-instrumentation-key"
     }
   }
   ```

## Project Structure
- `Program.cs`: Contains the application startup configuration
- `Pages/Index.cshtml`: The main page with buttons to trigger exceptions
- `Pages/Index.cshtml.cs`: The code-behind file containing methods to generate exceptions

## How to Use
1. Clone the repository or copy the code into a new ASP.NET Core Razor Pages project.
2. Install the required packages.
3. Configure the application as described in the Configuration section.
4. Run the application:
   ```
   dotnet run
   ```
5. Open a web browser and navigate to the application URL (typically `https://localhost:5001`).
6. Click on the various buttons to trigger different types of exceptions.
7. Check your Azure Application Insights resource to view the logged exceptions.

## Code Explanation

### Program.cs
This file sets up the ASP.NET Core application and adds necessary services:

```csharp
builder.Services.AddRazorPages();
builder.Services.AddApplicationInsightsTelemetry();
```

### Index.cshtml
This Razor Page provides buttons to trigger different exceptions:

```html
<button onclick="location.href='?handler=NullReference'">Null Reference Exception</button>
<button onclick="location.href='?handler=DivideByZero'">Divide By Zero Exception</button>
<button onclick="location.href='?handler=CustomException'">Custom Exception</button>
<button onclick="location.href='?handler=DatabaseError'">Broken Database Connection</button>
```

### Index.cshtml.cs
This file contains the logic to generate different exceptions:

```csharp
public IActionResult OnGetNullReference()
{
    string? nullString = null;
    var length = nullString.Length;  // This will throw a NullReferenceException
    return Page();
}

public IActionResult OnGetDivideByZero()
{
    int zero = 0;
    var result = 1 / zero;  // This will throw a DivideByZeroException
    return Page();
}

public IActionResult OnGetCustomException()
{
    throw new InvalidOperationException("This is a custom exception for demo purposes.");
}

public IActionResult OnGetDatabaseError()
{
    // This simulates a database connection error
    string connectionString = "Server=tcp:brokenserver.database.windows.net;Database=NonExistentDB;User Id=baduser;Password=badpassword;";
    try
    {
        using (SqlConnection connection = new SqlConnection(connectionString))
        {
            connection.Open(); 
        }
    }
    catch (SqlException ex)
    {
        throw new InvalidOperationException("Database connection failed.", ex);
    }
    return Page();
}
```

## Viewing Exceptions in Azure Application Insights
1. Log into the Azure Portal
2. Navigate to your Application Insights resource
3. In the left menu, click on "Failures" under the "Investigate" section
4. You should see the exceptions generated by the application

## Additional Notes
- This application is for demonstration purposes only and should not be used in a production environment without proper error handling and security measures.
- The database connection error uses a fake connection string. In a real application, never hard-code connection strings, especially in public repositories.
- Application Insights provides many more features for monitoring and diagnostics beyond exception logging. Explore its capabilities for a comprehensive monitoring solution.

## Troubleshooting
- If exceptions are not appearing in Application Insights, verify that your instrumentation key is correct and that the application has internet access to send telemetry data.
- Ensure that the Application Insights SDK is properly initialized in your application startup.
- Check Azure Portal notifications for any issues with your Application Insights resource.
